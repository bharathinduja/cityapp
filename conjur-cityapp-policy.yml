# Sample openshift authenticator policy policy
- !policy
  id: conjur/authn-k8s/sg-cluster

  body:
  - !webservice
    annotations:
      description: Authentication service for the "sg-cluster" cluster.

  - !policy
    id: ca                 # ca policy - do not change
    body:
    - !variable
      id: cert
      annotations:
        description: CA cert for Kubernetes Pods.

    - !variable
      id: key
      annotations:
        description: CA key for Kubernetes Pods.

  - !group
   id: clients
   annotations:
     description:
       Members of this group can use the sg-cluster
       authentication service. This group typically has one
       member, which is a layer containing the enrolled
       applications.

  - !permit
   resource: !webservice
   privilege: [ read, authenticate ]
   role: !group clients

  - !policy
    id: apps                    #apps policy - the id must be apps
    annotations:
      description: Apps and services in the "sg-cluster" Kubernetes cluster.
    body:
    - !layer
    - &hosts
      - !host
        id: cityapp/*/*
        annotations:
          kubernetes/authentication-container-name: authenticator
          openshift: true

      # add hosts to the apps layer
    - !grant
      role: !layer
      members: *hosts

  # add the apps layer to the clients group,
  # which has permission to authenticate to Conjur
  - !grant
    role: !group clients
    member: !layer apps

# Define secrets the app has access to
- !policy
  id: openshift-apps/cityapp
  owner: !group devops
  body:
  - !layer

  - !grant
    role: !layer
    members:
    - !host /conjur/authn-k8s/sg-cluster/apps/cityapp/*/*

- !policy
  id: Vault/Demo
  body:
  - &variables
    - !variable DB-App/cityapp/username
    - !variable DB-App/cityapp/password
  - !permit
    role: !layer /openshift-apps/cityapp
    privileges: [ read, execute ]
    resources: *variables
